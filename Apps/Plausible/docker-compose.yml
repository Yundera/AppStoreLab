name: plausible

services:
  plausible-db:
    image: postgres:16-alpine
    container_name: plausible-db
    restart: unless-stopped
    user: "0:0"
    volumes:
      - /DATA/AppData/$AppID/db:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: plausible
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d plausible"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        reservations:
          memory: 256M
    networks:
      - plausible-network
    cpu_shares: 50

  plausible-events-db:
    image: clickhouse/clickhouse-server:24.12-alpine
    container_name: plausible-events-db
    restart: unless-stopped
    user: "0:0"
    volumes:
      - /DATA/AppData/$AppID/event-data:/var/lib/clickhouse
      - /DATA/AppData/$AppID/event-logs:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      CLICKHOUSE_SKIP_USER_SETUP: 1
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 -O - http://127.0.0.1:8123/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        reservations:
          memory: 512M
    networks:
      - plausible-network
    cpu_shares: 50

  plausible:
    image: ghcr.io/plausible/community-edition:v3.1.0
    container_name: plausible
    restart: unless-stopped
    user: "0:0"
    command: >
      sh -c '
        echo "=== Plausible Starting ===" &&
        echo "Reading secrets..." &&
        export SECRET_KEY_BASE=$(cat /secrets/secret_key_base.txt) &&
        export TOTP_VAULT_KEY=$(cat /secrets/totp_vault_key.txt) &&
        echo "SECRET_KEY_BASE length: $${#SECRET_KEY_BASE}" &&
        echo "TOTP_VAULT_KEY length: $${#TOTP_VAULT_KEY}" &&
        if [ $${#SECRET_KEY_BASE} -lt 32 ]; then
          echo "ERROR: SECRET_KEY_BASE too short" &&
          exit 1
        fi &&
        if [ $${#TOTP_VAULT_KEY} -lt 32 ]; then
          echo "ERROR: TOTP_VAULT_KEY too short" &&
          exit 1
        fi &&
        echo "Starting database initialization..." &&
        /entrypoint.sh db createdb &&
        /entrypoint.sh db migrate &&
        echo "Starting Plausible application..." &&
        exec /entrypoint.sh run
      '
    depends_on:
      plausible-db:
        condition: service_healthy
      plausible-events-db:
        condition: service_healthy
    expose:
      - "80"
    volumes:
      - /DATA/AppData/$AppID/secrets:/secrets
    environment:
      BASE_URL: https://plausible-$PCS_DOMAIN
      DATABASE_URL: postgres://postgres:postgres@plausible-db:5432/plausible
      CLICKHOUSE_DATABASE_URL: http://plausible-events-db:8123/plausible_events_db
      DISABLE_REGISTRATION: invite_only
      LISTEN_IP: 0.0.0.0
      PORT: 80
    deploy:
      resources:
        reservations:
          memory: 512M
    networks:
      - plausible-network
    cpu_shares: 70

networks:
  plausible-network:
    driver: bridge

x-casaos:
  architectures:
    - amd64
    - arm64
  main: plausible
  author: Yundera Team
  category: Analytics
  description:
    en_us: |
      Plausible Analytics is a simple, open-source, lightweight (< 1 KB) and privacy-friendly web analytics alternative to Google Analytics. It doesn't use cookies and is fully compliant with GDPR, CCPA and PECR. Made and hosted in the EU, powered by European-owned cloud infrastructure.
      
      **Key Features:**
      - Lightweight script (< 1 KB) with no impact on page load times
      - No cookies or personal data collection
      - GDPR, CCPA, and PECR compliant out of the box
      - Simple, intuitive dashboard with all essential metrics
      - Publicly shareable dashboards for transparency
      - Goal conversions and custom event tracking
      - Real-time analytics with up-to-the-minute stats
      - Google Search Console integration
      - Self-hosted with full data ownership
      
      **First Time Setup:**
      After installation, visit your Plausible instance and create your first account. The first user automatically becomes the admin. You can then add websites to track and generate tracking scripts.
      
      **Privacy by Design:**
      Plausible Analytics is built with privacy as a core principle. It collects only aggregate data and doesn't track individual users across websites. All data is anonymized and no personal information is collected.
    ko_kr: |
      Plausible Analytics는 Google Analytics의 간단하고, 오픈소스이며, 가벼운 (< 1 KB) 프라이버시 친화적 웹 분석 대안입니다. 쿠키를 사용하지 않으며 GDPR, CCPA 및 PECR을 완전히 준수합니다. EU에서 제작 및 호스팅되며 유럽 소유의 클라우드 인프라로 구동됩니다.
      
      **주요 기능:**
      - 페이지 로드 시간에 영향을 주지 않는 경량 스크립트 (< 1 KB)
      - 쿠키나 개인 데이터 수집 없음
      - 기본적으로 GDPR, CCPA 및 PECR 준수
      - 모든 필수 지표를 포함한 간단하고 직관적인 대시보드
      - 투명성을 위한 공개 공유 가능한 대시보드
      - 목표 전환 및 커스텀 이벤트 추적
      - 실시간 분석 및 최신 통계
      - Google Search Console 통합
      - 완전한 데이터 소유권을 가진 셀프 호스팅
      
      **최초 설정:**
      설치 후 Plausible 인스턴스를 방문하여 첫 번째 계정을 생성하세요. 첫 번째 사용자는 자동으로 관리자가 됩니다. 그런 다음 추적할 웹사이트를 추가하고 추적 스크립트를 생성할 수 있습니다.
      
      **설계 기반 프라이버시:**
      Plausible Analytics는 프라이버시를 핵심 원칙으로 구축되었습니다. 집계 데이터만 수집하며 웹사이트 간 개별 사용자를 추적하지 않습니다. 모든 데이터는 익명화되며 개인 정보는 수집되지 않습니다.
    zh_cn: |
      Plausible Analytics 是一个简单、开源、轻量级(< 1 KB)且注重隐私的 Google Analytics 替代方案。它不使用 cookie，完全符合 GDPR、CCPA 和 PECR。在欧盟制造和托管，由欧洲所有的云基础设施提供支持。
      
      **主要功能:**
      - 轻量级脚本(< 1 KB)，不影响页面加载时间
      - 不使用 cookie 或收集个人数据
      - 开箱即用符合 GDPR、CCPA 和 PECR
      - 简单直观的仪表板，包含所有基本指标
      - 可公开分享的仪表板以提高透明度
      - 目标转化和自定义事件跟踪
      - 实时分析和最新统计数据
      - Google Search Console 集成
      - 自托管，完全拥有数据所有权
      
      **首次设置:**
      安装后，访问您的 Plausible 实例并创建您的第一个账户。第一个用户自动成为管理员。然后您可以添加要跟踪的网站并生成跟踪脚本。
      
      **隐私设计:**
      Plausible Analytics 以隐私为核心原则构建。它仅收集聚合数据，不跨网站跟踪个人用户。所有数据都是匿名的，不收集个人信息。
    es_es: |
      Plausible Analytics es una alternativa simple, de código abierto, ligera (< 1 KB) y respetuosa con la privacidad a Google Analytics. No utiliza cookies y cumple completamente con GDPR, CCPA y PECR. Hecho y alojado en la UE, impulsado por infraestructura cloud de propiedad europea.
      
      **Características principales:**
      - Script ligero (< 1 KB) sin impacto en los tiempos de carga de página
      - Sin cookies ni recopilación de datos personales
      - Cumple con GDPR, CCPA y PECR desde el principio
      - Panel simple e intuitivo con todas las métricas esenciales
      - Paneles compartibles públicamente para transparencia
      - Conversiones de objetivos y seguimiento de eventos personalizados
      - Análisis en tiempo real con estadísticas al minuto
      - Integración con Google Search Console
      - Auto-alojado con propiedad total de los datos
      
      **Configuración inicial:**
      Después de la instalación, visite su instancia de Plausible y cree su primera cuenta. El primer usuario se convierte automáticamente en administrador. Luego puede agregar sitios web para rastrear y generar scripts de seguimiento.
      
      **Privacidad por diseño:**
      Plausible Analytics está construido con la privacidad como principio fundamental. Recopila solo datos agregados y no rastrea usuarios individuales entre sitios web. Todos los datos están anonimizados y no se recopila información personal.
    fr_fr: |
      Plausible Analytics est une alternative simple, open-source, légère (< 1 Ko) et respectueuse de la vie privée à Google Analytics. Il n'utilise pas de cookies et est entièrement conforme au RGPD, CCPA et PECR. Fabriqué et hébergé dans l'UE, alimenté par une infrastructure cloud appartenant à l'Europe.
      
      **Fonctionnalités principales:**
      - Script léger (< 1 Ko) sans impact sur les temps de chargement
      - Pas de cookies ni de collecte de données personnelles
      - Conforme RGPD, CCPA et PECR dès le départ
      - Tableau de bord simple et intuitif avec toutes les métriques essentielles
      - Tableaux de bord partageables publiquement pour la transparence
      - Conversions d'objectifs et suivi d'événements personnalisés
      - Analyse en temps réel avec statistiques à la minute
      - Intégration Google Search Console
      - Auto-hébergé avec propriété complète des données
      
      **Configuration initiale:**
      Après l'installation, visitez votre instance Plausible et créez votre premier compte. Le premier utilisateur devient automatiquement administrateur. Vous pouvez ensuite ajouter des sites web à suivre et générer des scripts de suivi.
      
      **Confidentialité par conception:**
      Plausible Analytics est construit avec la confidentialité comme principe fondamental. Il ne collecte que des données agrégées et ne suit pas les utilisateurs individuels entre les sites web. Toutes les données sont anonymisées et aucune information personnelle n'est collectée.
  developer: Plausible Insights
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStoreLab@main/Apps/Plausible/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStoreLab@main/Apps/Plausible/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStoreLab@main/Apps/Plausible/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStoreLab@main/Apps/Plausible/screenshot-3.png
  tagline:
    en_us: Simple, open-source, lightweight and privacy-friendly web analytics
    ko_kr: 간단하고 오픈소스이며 가벼운 프라이버시 친화적 웹 분석
    zh_cn: 简单、开源、轻量级且注重隐私的网络分析
    es_es: Análisis web simple, de código abierto, ligero y respetuoso con la privacidad
    fr_fr: Analyse web simple, open-source, légère et respectueuse de la vie privée
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStoreLab@main/Apps/Plausible/thumbnail.png
  title:
    en_us: Plausible Analytics
  tips:
    before_install:
      en_us: |
        **First Time Setup:**
        
        1. After installation, visit your Plausible instance
        2. Create your first admin account
        3. Add your website and get the tracking script
        4. Install the tracking script on your website
        5. Start receiving analytics data!
        
        **Important Notes:**
        - The first user to register becomes the admin
        - Registration is set to "invite only" by default
        - Requires at least 2GB RAM for optimal performance
        - Uses PostgreSQL for user data and ClickHouse for analytics
        - Cryptographic secrets are automatically generated on first install
        
        For detailed configuration options, visit the [Plausible CE Wiki](https://github.com/plausible/community-edition/wiki)
  index: /
  webui_port: 80
  store_app_id: plausible
  pre-install-cmd: |
    echo "=== Plausible Pre-Install Script ==="
    echo "Creating directories..."
    mkdir -p /DATA/AppData/$AppID/db /DATA/AppData/$AppID/event-data /DATA/AppData/$AppID/event-logs /DATA/AppData/$AppID/secrets
    echo "Directory structure created"
    ls -la /DATA/AppData/$AppID/
    if [ ! -f /DATA/AppData/$AppID/secrets/secret_key_base.txt ]; then
      echo "Generating SECRET_KEY_BASE..."
      openssl rand -base64 64 | tr -d '\n' > /DATA/AppData/$AppID/secrets/secret_key_base.txt
      echo "SECRET_KEY_BASE generated"
    else
      echo "SECRET_KEY_BASE already exists"
    fi
    if [ ! -f /DATA/AppData/$AppID/secrets/totp_vault_key.txt ]; then
      echo "Generating TOTP_VAULT_KEY..."
      openssl rand -base64 32 | tr -d '\n' > /DATA/AppData/$AppID/secrets/totp_vault_key.txt
      echo "TOTP_VAULT_KEY generated"
    else
      echo "TOTP_VAULT_KEY already exists"
    fi
    echo "Secrets directory contents:"
    ls -la /DATA/AppData/$AppID/secrets/
    echo "Verifying secret files..."
    if [ -f /DATA/AppData/$AppID/secrets/secret_key_base.txt ]; then
      echo "secret_key_base.txt size: $(wc -c < /DATA/AppData/$AppID/secrets/secret_key_base.txt) bytes"
    fi
    if [ -f /DATA/AppData/$AppID/secrets/totp_vault_key.txt ]; then
      echo "totp_vault_key.txt size: $(wc -c < /DATA/AppData/$AppID/secrets/totp_vault_key.txt) bytes"
    fi
    echo "Setting permissions..."
    chown -R $PUID:$PGID /DATA/AppData/$AppID
    echo "Pre-install complete"